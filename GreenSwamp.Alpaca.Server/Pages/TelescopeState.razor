@page "/telescope-state"
@using GreenSwamp.Alpaca.Server.Services
@using GreenSwamp.Alpaca.Server.Models
@using ASCOM.Common.DeviceInterfaces
@inject TelescopeStateService StateService
@implements IDisposable

<PageTitle>Telescope State</PageTitle>

<h3>Telescope Device State</h3>

<div class="state-container">
    <div class="state-section">
        <h4>Connection & Status</h4>
        <div class="state-grid">
            <div class="state-item">
                <span class="state-label">Mount Running:</span>
                <span class="state-value @GetStatusClass(_state.IsMountRunning)">@_state.IsMountRunning</span>
            </div>
            <div class="state-item">
                <span class="state-label">Slewing:</span>
                <span class="state-value @GetStatusClass(_state.Slewing)">@_state.Slewing</span>
            </div>
            <div class="state-item">
                <span class="state-label">Tracking:</span>
                <span class="state-value @GetStatusClass(_state.Tracking)">@_state.Tracking</span>
            </div>
            <div class="state-item">
                <span class="state-label">At Park:</span>
                <span class="state-value @GetStatusClass(_state.AtPark)">@_state.AtPark</span>
            </div>
            <div class="state-item">
                <span class="state-label">At Home:</span>
                <span class="state-value @GetStatusClass(_state.AtHome)">@_state.AtHome</span>
            </div>
            <div class="state-item">
                <span class="state-label">Slew State:</span>
                <span class="state-value">@_state.SlewState</span>
            </div>
        </div>
    </div>

    <div class="state-section">
        <h4>Current Position (ASCOM)</h4>
        <div class="state-grid">
            <div class="state-item">
                <span class="state-label">Right Ascension:</span>
                <span class="state-value">@FormatHMS(_state.RightAscension)</span>
            </div>
            <div class="state-item">
                <span class="state-label">Declination:</span>
                <span class="state-value">@FormatDMS(_state.Declination)</span>
            </div>
            <div class="state-item">
                <span class="state-label">Altitude:</span>
                <span class="state-value">@FormatDegrees(_state.Altitude)</span>
            </div>
            <div class="state-item">
                <span class="state-label">Azimuth:</span>
                <span class="state-value">@FormatDegrees(_state.Azimuth)</span>
            </div>
            <div class="state-item">
                <span class="state-label">Side of Pier:</span>
                <span class="state-value">@_state.SideOfPier</span>
            </div>
            <div class="state-item">
                <span class="state-label">Local Hour Angle:</span>
                <span class="state-value">@FormatHMS(_state.LocalHourAngle)</span>
            </div>
        </div>
    </div>

    <div class="state-section">
        <h4>Target Position</h4>
        <div class="state-grid">
            <div class="state-item">
                <span class="state-label">Target RA:</span>
                <span class="state-value">@FormatHMS(_state.TargetRightAscension)</span>
            </div>
            <div class="state-item">
                <span class="state-label">Target Dec:</span>
                <span class="state-value">@FormatDMS(_state.TargetDeclination)</span>
            </div>
        </div>
    </div>

    <div class="state-section">
        <h4>Axis Positions (Mount Coordinates)</h4>
        <div class="state-grid">
            <div class="state-item">
                <span class="state-label">Actual Axis X:</span>
                <span class="state-value">@FormatDegrees(_state.ActualAxisX)</span>
            </div>
            <div class="state-item">
                <span class="state-label">Actual Axis Y:</span>
                <span class="state-value">@FormatDegrees(_state.ActualAxisY)</span>
            </div>
            <div class="state-item">
                <span class="state-label">App Axis X:</span>
                <span class="state-value">@FormatDegrees(_state.AppAxisX)</span>
            </div>
            <div class="state-item">
                <span class="state-label">App Axis Y:</span>
                <span class="state-value">@FormatDegrees(_state.AppAxisY)</span>
            </div>
            <div class="state-item">
                <span class="state-label">Axis 1 Steps:</span>
                <span class="state-value">@_state.Axis1Steps.ToString("N0")</span>
            </div>
            <div class="state-item">
                <span class="state-label">Axis 2 Steps:</span>
                <span class="state-value">@_state.Axis2Steps.ToString("N0")</span>
            </div>
        </div>
    </div>

    <div class="state-section">
        <h4>Tracking & Guiding</h4>
        <div class="state-grid">
            <div class="state-item">
                <span class="state-label">Pulse Guide RA:</span>
                <span class="state-value @GetStatusClass(_state.IsPulseGuidingRa)">@_state.IsPulseGuidingRa</span>
            </div>
            <div class="state-item">
                <span class="state-label">Pulse Guide Dec:</span>
                <span class="state-value @GetStatusClass(_state.IsPulseGuidingDec)">@_state.IsPulseGuidingDec</span>
            </div>
            <div class="state-item">
                <span class="state-label">Tracking Rate:</span>
                <span class="state-value">@_state.TrackingRate</span>
            </div>
        </div>
    </div>

    <div class="state-section">
        <h4>Time & Performance</h4>
        <div class="state-grid">
            <div class="state-item">
                <span class="state-label">UTC Date:</span>
                <span class="state-value">@_state.UTCDate.ToString("yyyy-MM-dd HH:mm:ss.fff")</span>
            </div>
            <div class="state-item">
                <span class="state-label">Local Date:</span>
                <span class="state-value">@_state.LocalDate.ToString("yyyy-MM-dd HH:mm:ss.fff")</span>
            </div>
            <div class="state-item">
                <span class="state-label">Loop Counter:</span>
                <span class="state-value">@_state.LoopCounter.ToString("N0")</span>
            </div>
            <div class="state-item">
                <span class="state-label">Timer Overruns:</span>
                <span class="state-value @GetWarningClass(_state.TimerOverruns)">@_state.TimerOverruns</span>
            </div>
            <div class="state-item">
                <span class="state-label">Last Update:</span>
                <span class="state-value">@_state.LastUpdate.ToString("HH:mm:ss.fff")</span>
            </div>
        </div>
    </div>
</div>

@code {
    private TelescopeStateModel _state = new();
    
    protected override void OnInitialized()
    {
        // Subscribe to state changes
        StateService.StateChanged += OnStateChanged;
        
        // Get initial state
        _state = StateService.GetCurrentState();
    }
    
    private void OnStateChanged(object? sender, TelescopeStateModel newState)
    {
        _state = newState;
        InvokeAsync(StateHasChanged);
    }
    
    public void Dispose()
    {
        StateService.StateChanged -= OnStateChanged;
    }
    
    private string FormatHMS(double hours)
    {
        if (double.IsNaN(hours) || double.IsInfinity(hours))
            return "N/A";

        var sign = hours < 0 ? "-" : "+";
        hours = Math.Abs(hours);

        
        var h = (int)hours;
        var m = (int)((hours - h) * 60);
        var s = ((hours - h) * 60 - m) * 60;
        
        return $"{sign}{h:00}h {m:00}m {s:00.00}s";
    }
    
    private string FormatDMS(double degrees)
    {
        if (double.IsNaN(degrees) || double.IsInfinity(degrees))
            return "N/A";
        
        var sign = degrees < 0 ? "-" : "+";
        degrees = Math.Abs(degrees);
        
        var d = (int)degrees;
        var m = (int)((degrees - d) * 60);
        var s = ((degrees - d) * 60 - m) * 60;
        
        return $"{sign}{d:00}° {m:00}' {s:00.0}\"";
    }
    
    private string FormatDegrees(double degrees)
    {
        if (double.IsNaN(degrees) || double.IsInfinity(degrees))
            return "N/A";
        
        return $"{degrees:F4}°";
    }
    
    private string GetStatusClass(bool status)
    {
        return status ? "status-active" : "status-inactive";
    }
    
    private string GetWarningClass(int value)
    {
        return value > 0 ? "status-warning" : "";
    }
}
